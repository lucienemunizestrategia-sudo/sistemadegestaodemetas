<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestão de Metas - Prospera Rio</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --azul-principal: #092040;
  --azul-secundaria: #00B7D7;
  --amarelo-acento: #ECC203;
  --cinza-neutro: #EFF1F3;
  --azul-escuro: #021738;
  --branco: #FFFFFF;
}
body { font-family: 'Open Sans', sans-serif; background: var(--cinza-neutro); color: var(--azul-escuro); line-height: 1.6; }
h1, h2, h3, h4 { font-family: 'Montserrat', sans-serif; font-weight: 700; }
.hdr { background: var(--azul-principal); color: var(--branco); padding: 20px 40px; }
.hdr-top { display: flex; justify-content: space-between; align-items: center; }
.tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
.tab { background: rgba(255,255,255,0.1); color: var(--branco); padding: 12px 24px; border: none; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s; }
.tab:hover { background: rgba(255,255,255,0.2); }
.tab.active { background: var(--amarelo-acento); color: var(--azul-escuro); }
.main { padding: 40px 20px; max-width: 1400px; margin: 0 auto; }
.dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
.stat-card { background: var(--branco); padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(2, 23, 56, 0.08); border-left: 5px solid var(--azul-secundaria); }
.stat-number { font-size: 48px; font-weight: 700; color: var(--azul-principal); }
.filters { background: var(--branco); padding: 24px; border-radius: 8px; margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
.filter-group { flex: 1; min-width: 200px; }
input, textarea, select { width: 100%; padding: 12px 16px; margin: 8px 0; border: 2px solid var(--azul-secundaria); border-radius: 6px; font-size: 16px; }
label { display: block; font-weight: 600; color: var(--azul-escuro); margin-top: 16px; margin-bottom: 6px; }
button { padding: 14px 28px; margin: 8px 8px 8px 0; background: var(--azul-secundaria); color: var(--branco); border: none; cursor: pointer; border-radius: 6px; font-weight: 600; font-size: 14px; transition: all 0.3s; }
button:hover { background: #0099b8; }
button:disabled { background: #ccc; cursor: not-allowed; }
.box { background: var(--branco); padding: 32px; margin: 24px 0; border-radius: 8px; border-left: 4px solid var(--azul-secundaria); }
.login { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--azul-principal) 0%, var(--azul-secundaria) 100%); }
.login-box { background: var(--branco); padding: 50px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center; }
.logo { max-width: 280px; margin-bottom: 20px; }
.meta-card { background: #f8f9fa; padding: 24px; margin: 16px 0; border-radius: 8px; border-left: 5px solid var(--azul-secundaria); }
.meta-status { padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: 700; display: inline-block; }
.status-andamento { background: #fff3cd; color: #856404; }
.status-encerrada { background: #d4edda; color: #155724; }
.btn-success { background: #28a745; }
.btn-danger { background: #dc3545; }
.btn-secondary { background: #6c757d; }
.etapa-section { background: var(--branco); padding: 32px; margin: 24px 0; border-radius: 8px; }
.hdr-btns button { background: var(--amarelo-acento); color: var(--azul-escuro); }
</style>
</head>
<body>
<div id="app"></div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYi7mEll9Y8RcDCfK7GM87vVZy9JXDnvxqk-RtfkQoXZzE_ebj8MXV7_vNx-3kuZ_4/exec';

var dados = {
  ok: false,
  visualizacao: 'dashboard',
  metasMare: [],
  metasJacarezinho: [],
  carregando: false,
  filtros: { etapa: '', status: '', dataInicio: '', dataFim: '' }
};

async function carregarTodasMetas() {
  dados.carregando = true;
  renderizar();
  
  try {
    const [responseMare, responseJacare] = await Promise.all([
      fetch(SCRIPT_URL + '?action=get&local=Maré'),
      fetch(SCRIPT_URL + '?action=get&local=Jacarezinho')
    ]);
    
    const resultMare = await responseMare.json();
    const resultJacare = await responseJacare.json();
    
    if (resultMare.success) dados.metasMare = resultMare.data || [];
    if (resultJacare.success) dados.metasJacarezinho = resultJacare.data || [];
    
    dados.carregando = false;
    renderizar();
  } catch (error) {
    console.error('Erro:', error);
    dados.carregando = false;
    alert('Erro ao carregar dados: ' + error.message);
    renderizar();
  }
}

async function salvarMeta(meta, local) {
  try {
    const params = new URLSearchParams();
    params.append('action', 'add');
    params.append('local', local);
    params.append('e', meta.e);
    params.append('m', meta.m);
    params.append('c', meta.c);
    params.append('st', meta.st);
    params.append('a', meta.a);
    params.append('d', meta.d);
    params.append('o', meta.o);
    params.append('l', meta.l);
    params.append('listaPresenca', meta.listaPresenca);
    params.append('fotos', meta.fotos);
    params.append('materialDivulgacao', meta.materialDivulgacao);
    
    const response = await fetch(SCRIPT_URL, { method: 'POST', body: params });
    const result = await response.json();
    
    if (result.success) {
      await carregarTodasMetas();
      return true;
    } else {
      throw new Error(result.message || 'Erro ao salvar');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao salvar meta: ' + error.message);
    return false;
  }
}

async function apagarMeta(id, local) {
  try {
    const params = new URLSearchParams();
    params.append('action', 'delete');
    params.append('local', local);
    params.append('id', id);
    
    const response = await fetch(SCRIPT_URL, { method: 'POST', body: params });
    const result = await response.json();
    
    if (result.success) {
      await carregarTodasMetas();
      return true;
    } else throw new Error(result.message || 'Erro ao apagar');
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao apagar meta: ' + error.message);
    return false;
  }
}

function calcularEstatisticas(metas) {
  return {
    total: metas.length,
    emAndamento: metas.filter(m => m.st === 'Em andamento').length,
    encerradas: metas.filter(m => m.st === 'Encerrada').length,
    mediaProgresso: metas.length > 0 ? Math.round(metas.reduce((acc, m) => acc + (parseInt(m.a) || 0), 0) / metas.length) : 0
  };
}

function agruparPorEtapa(metas) {
  const grupos = {};
  metas.forEach(meta => {
    const etapa = meta.e || 'Sem Etapa';
    if (!grupos[etapa]) grupos[etapa] = [];
    grupos[etapa].push(meta);
  });
  return grupos;
}

function filtrarMetas(metas) {
  return metas.filter(meta => {
    if (dados.filtros.etapa && meta.e !== dados.filtros.etapa) return false;
    if (dados.filtros.status && meta.st !== dados.filtros.status) return false;
    if (dados.filtros.dataInicio && meta.d < dados.filtros.dataInicio) return false;
    if (dados.filtros.dataFim && meta.d > dados.filtros.dataFim) return false;
    return true;
  });
}

function obterEtapasUnicas() {
  const todasMetas = [...dados.metasMare, ...dados.metasJacarezinho];
  const etapas = [...new Set(todasMetas.map(m => m.e).filter(e => e))];
  return etapas.sort();
}

function exportarParaExcel() {
  const metas = dados.visualizacao === 'mare' ? dados.metasMare : dados.visualizacao === 'jacarezinho' ? dados.metasJacarezinho : [...dados.metasMare, ...dados.metasJacarezinho];
  let csv = 'Território,Etapa,Meta,Comprovação,Status,Alcançada (%),Data,Observações,Link\n';
  metas.forEach(meta => {
    const territorio = dados.metasMare.includes(meta) ? 'Maré' : 'Jacarezinho';
    csv += `"${territorio}","${meta.e}","${meta.m}","${meta.c}","${meta.st}","${meta.a}","${meta.d}","${meta.o}","${meta.l}"\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `prospera-rio-metas-${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}

function renderizar() {
  const app = document.getElementById('app');
  if (!dados.ok) {
    app.innerHTML = `
      <div class="login">
        <div class="login-box">
          <img class="logo" src="https://lh3.googleusercontent.com/d/1x5sNkC9vd7CI78y0xdkWvgoadxPEMcIf=w800" alt="Prospera Rio">
          <h3 style="color: var(--azul-principal); margin: 24px 0;">Gestão de Metas e Evidências</h3>
          <input id="senha" type="password" placeholder="Digite a senha" style="margin: 24px 0;">
          <button class="btn-primary" onclick="fazerLogin()" style="width: 100%; background: var(--azul-secundaria);">ENTRAR</button>
        </div>
      </div>
    `;
  } else {
    let conteudo = '';
    if (dados.visualizacao === 'dashboard') conteudo = telaDashboard();
    else if (dados.visualizacao === 'mare') conteudo = telaTerritorioCompleta('Maré', dados.metasMare);
    else if (dados.visualizacao === 'jacarezinho') conteudo = telaTerritorioCompleta('Jacarezinho', dados.metasJacarezinho);
    else if (dados.visualizacao === 'cadastro') conteudo = telaCadastro();
    
    app.innerHTML = `
      <div class="hdr">
        <div class="hdr-top">
          <h2>PROSPERA RIO - GESTÃO DE METAS</h2>
          <div class="hdr-btns">
            <button onclick="exportarParaExcel()" class="btn-success">EXPORTAR EXCEL</button>
            <button onclick="sair()">SAIR</button>
          </div>
        </div>
        <div class="tabs">
          <button class="tab ${dados.visualizacao === 'dashboard' ? 'active' : ''}" onclick="mudarVisualizacao('dashboard')">Dashboard</button>
          <button class="tab ${dados.visualizacao === 'mare' ? 'active' : ''}" onclick="mudarVisualizacao('mare')">Maré</button>
          <button class="tab ${dados.visualizacao === 'jacarezinho' ? 'active' : ''}" onclick="mudarVisualizacao('jacarezinho')">Jacarezinho</button>
          <button class="tab ${dados.visualizacao === 'cadastro' ? 'active' : ''}" onclick="mudarVisualizacao('cadastro')">Nova Meta</button>
        </div>
      </div>
      <div class="main">${conteudo}</div>
    `;
  }
}

function telaDashboard() {
  const stats = { mare: calcularEstatisticas(dados.metasMare), jacare: calcularEstatisticas(dados.metasJacarezinho) };
  const total = { total: stats.mare.total + stats.jacare.total, em: stats.mare.emAndamento + stats.jacare.emAndamento, enc: stats.mare.encerradas + stats.jacare.encerradas };
  
  return `
    <h3 style="color: var(--azul-principal); margin-bottom: 30px;">Visão Geral</h3>
    <div class="dashboard">
      <div class="stat-card"><h4>TOTAL DE METAS</h4><div class="stat-number">${total.total}</div></div>
      <div class="stat-card"><h4>EM ANDAMENTO</h4><div class="stat-number" style="color: #ffc107;">${total.em}</div></div>
      <div class="stat-card"><h4>ENCERRADAS</h4><div class="stat-number" style="color: #28a745;">${total.enc}</div></div>
    </div>
    <h3 style="color: var(--azul-principal); margin: 40px 0 30px;">Maré</h3>
    <div class="dashboard">
      <div class="stat-card"><h4>TOTAL</h4><div class="stat-number">${stats.mare.total}</div></div>
      <div class="stat-card"><h4>EM ANDAMENTO</h4><div class="stat-number" style="color: #ffc107;">${stats.mare.emAndamento}</div></div>
      <div class="stat-card"><h4>ENCERRADAS</h4><div class="stat-number" style="color: #28a745;">${stats.mare.encerradas}</div></div>
    </div>
    <h3 style="color: var(--azul-principal); margin: 40px 0 30px;">Jacarezinho</h3>
    <div class="dashboard">
      <div class="stat-card"><h4>TOTAL</h4><div class="stat-number">${stats.jacare.total}</div></div>
      <div class="stat-card"><h4>EM ANDAMENTO</h4><div class="stat-number" style="color: #ffc107;">${stats.jacare.emAndamento}</div></div>
      <div class="stat-card"><h4>ENCERRADAS</h4><div class="stat-number" style="color: #28a745;">${stats.jacare.encerradas}</div></div>
    </div>
  `;
}

function telaTerritorioCompleta(territorio, metas) {
  const metasFiltradas = filtrarMetas(metas);
  const gruposPorEtapa = agruparPorEtapa(metasFiltradas);
  const etapas = Object.keys(gruposPorEtapa).sort();
  const stats = calcularEstatisticas(metas);
  
  let html = `
    <h3 style="color: var(--azul-principal); margin-bottom: 30px;">${territorio} - Todas as Metas</h3>
    <div class="dashboard" style="margin-bottom: 30px;">
      <div class="stat-card"><h4>TOTAL</h4><div class="stat-number">${stats.total}</div></div>
      <div class="stat-card"><h4>EM ANDAMENTO</h4><div class="stat-number" style="color: #ffc107;">${stats.emAndamento}</div></div>
      <div class="stat-card"><h4>ENCERRADAS</h4><div class="stat-number" style="color: #28a745;">${stats.encerradas}</div></div>
    </div>
    
    <div class="filters">
      <div class="filter-group">
        <label>Filtrar por Etapa:</label>
        <select onchange="aplicarFiltro('etapa', this.value)">
          <option value="">Todas as etapas</option>
          ${obterEtapasUnicas().map(e => `<option value="${e}" ${dados.filtros.etapa === e ? 'selected' : ''}>${e}</option>`).join('')}
        </select>
      </div>
      <div class="filter-group">
        <label>Filtrar por Status:</label>
        <select onchange="aplicarFiltro('status', this.value)">
          <option value="">Todos</option>
          <option value="Em andamento" ${dados.filtros.status === 'Em andamento' ? 'selected' : ''}>Em andamento</option>
          <option value="Encerrada" ${dados.filtros.status === 'Encerrada' ? 'selected' : ''}>Encerrada</option>
        </select>
      </div>
      <button onclick="limparFiltros()" class="btn-secondary">LIMPAR FILTROS</button>
    </div>
  `;
  
  if (metasFiltradas.length === 0) {
    html += '<div style="text-align: center; color: #6c757d; padding: 60px 20px;">Nenhuma meta encontrada.</div>';
  } else {
    etapas.forEach(etapa => {
      const metasEtapa = gruposPorEtapa[etapa];
      html += `<div class="etapa-section"><h3>${etapa} (${metasEtapa.length})</h3>`;
      
      metasEtapa.forEach(meta => {
        const statusClass = meta.st === 'Encerrada' ? 'status-encerrada' : 'status-andamento';
        html += `
          <div class="meta-card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
              <span style="color: #6c757d; font-size: 12px;">#${meta.id ? meta.id.substring(0, 8) : 'N/A'}</span>
              <span class="meta-status ${statusClass}">${meta.st || 'Em andamento'}</span>
            </div>
            <p style="font-size: 18px; font-weight: 600; margin: 12px 0;">${meta.m || 'Sem descrição'}</p>
            ${meta.c ? `<p><strong>Comprovação:</strong> ${meta.c}</p>` : ''}
            ${meta.d ? `<p><strong>Data:</strong> ${meta.d}</p>` : ''}
            ${meta.o ? `<p><strong>Observações:</strong> ${meta.o}</p>` : ''}
            ${meta.l ? `<p><strong>Evidência:</strong> <a href="${meta.l}" target="_blank" style="color: var(--azul-secundaria);">Abrir link</a></p>` : ''}
            <button class="btn-danger" onclick="confirmarExclusao('${meta.id}', '${territorio}')" style="margin-top: 12px;">APAGAR</button>
          </div>
        `;
      });
      
      html += '</div>';
    });
  }
  
  return html;
}

function telaCadastro() {
  return `
    <div class="box">
      <h3 style="color: var(--azul-principal); margin-bottom: 24px;">Cadastrar Nova Meta</h3>
      
      <label class="field-required">Território</label>
      <select id="territorio">
        <option value="Maré">Maré</option>
        <option value="Jacarezinho">Jacarezinho</option>
      </select>
      
      <label class="field-required">Etapa</label>
      <input id="etapa" placeholder="Ex: Etapa 1, Fase Inicial, etc.">
      
      <label class="field-required">Descrição da Meta</label>
      <textarea id="meta" placeholder="Descreva detalhadamente a meta..."></textarea>
      
      <label>Forma de Comprovação</label>
      <input id="comprovacao" placeholder="Como esta meta será comprovada?">
      
      <label>Status da Meta</label>
      <select id="status"><option>Em andamento</option><option>Encerrada</option></select>
      
      <label>Percentual Alcançado (%)</label>
      <input id="alcancada" type="number" placeholder="0 a 100" min="0" max="100">
      
      <label>Data de Referência</label>
      <input id="data" type="date">
      
      <label>Observações Adicionais</label>
      <textarea id="observacao" placeholder="Informações complementares..."></textarea>
      
      <label>Link de Evidência</label>
      <input id="link" placeholder="https://" type="url">
      
      <label>Link da Lista de Presença</label>
      <input id="listaPresenca" placeholder="https://drive.google.com/..." type="url">
      
      <label>Link das Fotos</label>
      <input id="fotos" placeholder="https://drive.google.com/..." type="url">
      
      <label>Link do Material de Divulgação</label>
      <input id="materialDivulgacao" placeholder="https://drive.google.com/..." type="url">
      
      <div style="margin-top: 32px;">
        <button class="btn-primary" onclick="salvarNovaMeta()" id="btnSalvar" style="background: var(--azul-secundaria);">SALVAR META</button>
        <button class="btn-secondary" onclick="mudarVisualizacao('dashboard')">CANCELAR</button>
      </div>
    </div>
  `;
}

function fazerLogin() {
  const senha = document.getElementById('senha').value;
  if (senha === 'prospera2025') {
    dados.ok = true;
    carregarTodasMetas();
  } else {
    alert('Senha incorreta!');
  }
}

function sair() {
  if (confirm('Deseja sair?')) {
    dados.ok = false;
    dados.visualizacao = 'dashboard';
    renderizar();
  }
}

function mudarVisualizacao(tipo) {
  dados.visualizacao = tipo;
  renderizar();
}

function aplicarFiltro(tipo, valor) {
  dados.filtros[tipo] = valor;
  renderizar();
}

function limparFiltros() {
  dados.filtros = { etapa: '', status: '', dataInicio: '', dataFim: '' };
  renderizar();
}

async function salvarNovaMeta() {
  const btnSalvar = document.getElementById('btnSalvar');
  btnSalvar.disabled = true;
  btnSalvar.textContent = 'SALVANDO...';
  
  const meta = {
    e: document.getElementById('etapa').value.trim(),
    m: document.getElementById('meta').value.trim(),
    c: document.getElementById('comprovacao').value.trim(),
    st: document.getElementById('status').value,
    a: document.getElementById('alcancada').value,
    d: document.getElementById('data').value,
    o: document.getElementById('observacao').value.trim(),
    l: document.getElementById('link').value.trim(),
    listaPresenca: document.getElementById('listaPresenca').value.trim(),
    fotos: document.getElementById('fotos').value.trim(),
    materialDivulgacao: document.getElementById('materialDivulgacao').value.trim()
  };
  
  const territorio = document.getElementById('territorio').value;
  
  if (!meta.e || !meta.m) {
    alert('Preencha os campos obrigatórios: Etapa e Descrição da Meta');
    btnSalvar.disabled = false;
    btnSalvar.textContent = 'SALVAR META';
    return;
  }
  
  const sucesso = await salvarMeta(meta, territorio);
  if (sucesso) {
    alert('Meta cadastrada com sucesso!');
    dados.visualizacao = territorio === 'Maré' ? 'mare' : 'jacarezinho';
    renderizar();
  } else {
    btnSalvar.disabled = false;
    btnSalvar.textContent = 'SALVAR META';
  }
}

async function confirmarExclusao(id, territorio) {
  if (confirm('Deseja realmente apagar esta meta?')) {
    const sucesso = await apagarMeta(id, territorio);
    if (sucesso) alert('Meta apagada com sucesso!');
  }
}

renderizar();
</script>
</body>
</html>
