<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestão de Metas e Evidências - Prospera Rio</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}

:root {
  --azul-principal: #092040;
  --azul-secundaria: #00B7D7;
  --amarelo-acento: #ECC203;
  --cinza-neutro: #EFF1F3;
  --azul-escuro: #021738;
  --branco: #FFFFFF;
}

body { 
  font-family: 'Open Sans', sans-serif; 
  background: var(--cinza-neutro); 
  color: var(--azul-escuro);
  line-height: 1.6;
}

h1, h2, h3, h4 { 
  font-family: 'Montserrat', sans-serif; 
  font-weight: 700;
}

h1 { font-size: 44px; }
h2 { font-size: 32px; }
h3 { font-size: 28px; font-weight: 600; }
h4 { font-size: 20px; }

.hdr { 
  background: var(--azul-principal); 
  color: var(--branco); 
  padding: 20px 40px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.hdr-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.hdr h2 {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.hdr-btns button {
  background: var(--amarelo-acento);
  color: var(--azul-escuro);
  padding: 12px 24px;
  border: none;
  border-radius: 6px;
  font-family: 'Montserrat', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  margin-left: 10px;
  transition: all 0.3s;
  text-transform: uppercase;
}

.hdr-btns button:hover { 
  background: #d4ac02;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(236, 194, 3, 0.3);
}

.tabs {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.tab {
  background: rgba(255,255,255,0.1);
  color: var(--branco);
  padding: 12px 24px;
  border: none;
  border-radius: 6px 6px 0 0;
  font-family: 'Montserrat', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  text-transform: uppercase;
}

.tab:hover {
  background: rgba(255,255,255,0.2);
}

.tab.active {
  background: var(--amarelo-acento);
  color: var(--azul-escuro);
}

.main { 
  padding: 40px 20px; 
  max-width: 1400px; 
  margin: 0 auto; 
}

.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 40px;
}

.stat-card {
  background: var(--branco);
  padding: 24px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(2, 23, 56, 0.08);
  border-left: 5px solid var(--azul-secundaria);
  transition: all 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 16px rgba(2, 23, 56, 0.12);
}

.stat-card.mare {
  border-left-color: #00B7D7;
}

.stat-card.jacarezinho {
  border-left-color: #ECC203;
}

.stat-card h4 {
  color: var(--azul-escuro);
  margin-bottom: 10px;
  font-size: 16px;
}

.stat-number {
  font-size: 48px;
  font-weight: 700;
  color: var(--azul-principal);
  font-family: 'Montserrat', sans-serif;
}

.stat-label {
  font-size: 14px;
  color: #6c757d;
  margin-top: 5px;
}

.filters {
  background: var(--branco);
  padding: 24px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(2, 23, 56, 0.08);
  margin-bottom: 30px;
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  align-items: flex-end;
}

.filter-group {
  flex: 1;
  min-width: 200px;
}

input, textarea, select { 
  width: 100%; 
  padding: 12px 16px; 
  margin: 8px 0; 
  border: 2px solid var(--azul-secundaria); 
  border-radius: 6px;
  font-family: 'Open Sans', sans-serif;
  font-size: 16px;
  background: var(--branco);
  color: var(--azul-escuro);
  transition: all 0.3s;
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--azul-principal);
  box-shadow: 0 0 0 3px rgba(0, 183, 215, 0.1);
}

textarea { 
  min-height: 100px; 
  resize: vertical;
}

label {
  display: block;
  font-weight: 600;
  color: var(--azul-escuro);
  margin-top: 16px;
  margin-bottom: 6px;
  font-size: 16px;
}

button { 
  padding: 14px 28px; 
  margin: 8px 8px 8px 0; 
  background: var(--azul-secundaria); 
  color: var(--branco); 
  border: none; 
  cursor: pointer; 
  border-radius: 6px;
  font-family: 'Montserrat', sans-serif;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

button:hover { 
  background: #0099b8;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 183, 215, 0.3);
}

button:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
}

.btn-primary {
  background: var(--azul-secundaria);
  font-size: 16px;
  padding: 16px 32px;
}

.btn-action {
  background: var(--amarelo-acento);
  color: var(--azul-escuro);
}

.btn-secondary {
  background: #6c757d;
}

.btn-danger {
  background: #dc3545;
}

.btn-success {
  background: #28a745;
}

.box { 
  background: var(--branco); 
  padding: 32px; 
  margin: 24px 0; 
  border-radius: 8px; 
  box-shadow: 0 2px 8px rgba(2, 23, 56, 0.08);
  border-left: 4px solid var(--azul-secundaria);
}

.login { 
  min-height: 100vh; 
  display: flex; 
  align-items: center; 
  justify-content: center;
  background: linear-gradient(135deg, var(--azul-principal) 0%, var(--azul-secundaria) 100%);
}

.login-box {
  background: var(--branco);
  padding: 50px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  text-align: center;
  max-width: 500px;
  width: 90%;
}

.logo-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  margin-bottom: 30px;
}

.logo {
  display: block;
  margin: 0 auto 20px;
  max-width: 280px;
  height: auto;
}

.location-text {
  color: var(--amarelo-acento);
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  font-size: 20px;
  letter-spacing: 2px;
}

.etapa-section {
  background: var(--branco);
  padding: 32px;
  margin: 24px 0;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(2, 23, 56, 0.08);
}

.etapa-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 16px;
  border-bottom: 3px solid var(--amarelo-acento);
  margin-bottom: 24px;
}

.etapa-title {
  color: var(--azul-principal);
  font-size: 28px;
  font-weight: 700;
  font-family: 'Montserrat', sans-serif;
}

.etapa-count {
  background: var(--azul-secundaria);
  color: var(--branco);
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 700;
  font-size: 16px;
}

.meta-card {
  background: #f8f9fa;
  padding: 24px;
  margin: 16px 0;
  border-radius: 8px;
  border-left: 5px solid var(--azul-secundaria);
  transition: all 0.3s;
}

.meta-card:hover {
  box-shadow: 0 4px 16px rgba(2, 23, 56, 0.12);
  transform: translateX(4px);
}

.meta-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 12px;
}

.meta-id {
  color: #6c757d;
  font-size: 14px;
  font-family: 'Courier New', monospace;
}

.meta-status {
  padding: 8px 20px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-family: 'Montserrat', sans-serif;
}

.status-andamento {
  background: #fff3cd;
  color: #856404;
  border: 2px solid #ffc107;
}

.status-encerrada {
  background: #d4edda;
  color: #155724;
  border: 2px solid #28a745;
}

.meta-texto {
  color: var(--azul-escuro);
  line-height: 1.8;
  margin: 16px 0;
  font-size: 18px;
  font-weight: 600;
}

.meta-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin: 20px 0;
  padding: 20px;
  background: var(--branco);
  border-radius: 8px;
}

.meta-info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.meta-info-label {
  color: var(--azul-principal);
  font-weight: 700;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.meta-info-value {
  color: var(--azul-escuro);
  font-size: 16px;
}

.meta-link {
  color: var(--azul-secundaria);
  text-decoration: none;
  font-weight: 600;
  transition: all 0.3s;
}

.meta-link:hover {
  color: var(--azul-principal);
  text-decoration: underline;
}

.progress-bar {
  width: 100%;
  height: 30px;
  background: #e9ecef;
  border-radius: 15px;
  overflow: hidden;
  margin: 10px 0;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--azul-secundaria), var(--amarelo-acento));
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--branco);
  font-weight: 700;
  transition: width 0.5s ease;
}

.territorio-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 4px;
  font-weight: 700;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.territorio-badge.mare {
  background: #00B7D7;
  color: var(--branco);
}

.territorio-badge.jacarezinho {
  background: #ECC203;
  color: var(--azul-escuro);
}

.loading {
  text-align: center;
  padding: 60px 20px;
  color: var(--azul-secundaria);
  font-weight: 600;
  font-size: 18px;
}

.vazio {
  text-align: center;
  color: #6c757d;
  padding: 60px 20px;
  font-size: 18px;
}

.form-title {
  color: var(--azul-principal);
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 24px;
  border-bottom: 4px solid var(--amarelo-acento);
  padding-bottom: 12px;
  font-family: 'Montserrat', sans-serif;
}

.field-required::after {
  content: " *";
  color: #dc3545;
  font-weight: 700;
}

.export-section {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin: 20px 0;
}

@media print {
  .hdr-btns, .filters, .export-section, button {
    display: none !important;
  }
}

@media (max-width: 768px) {
  .hdr-top {
    flex-direction: column;
    gap: 16px;
  }
  
  .dashboard {
    grid-template-columns: 1fr;
  }
  
  .filters {
    flex-direction: column;
  }
  
  h1 { font-size: 32px; }
  h2 { font-size: 24px; }
  h3 { font-size: 20px; }
  
  .logo {
    max-width: 200px;
  }
  
  .meta-info-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
<div id="app"></div>

<script>
// ============================================
// CONFIGURAÇÃO
// ============================================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYi7mEll9Y8RcDCfK7GM87vVZy9JXDnvxqk-RtfkQoXZzE_ebj8MXV7_vNx-3kuZ_4/exec';
// ============================================
// VARIÁVEIS GLOBAIS
// ============================================
var dados = {
  ok: false,
  visualizacao: 'dashboard', // dashboard, mare, jacarezinho, cadastro
  metasMare: [],
  metasJacarezinho: [],
  mostrarForm: false,
  carregando: false,
  filtros: {
    etapa: '',
    status: '',
    dataInicio: '',
    dataFim: ''
  }
};

// ============================================
// FUNÇÕES DE API
// ============================================

async function carregarTodasMetas() {
  dados.carregando = true;
  renderizar();
  
  try {
    console.log('=== Carregando metas ===');
    console.log('URL:', SCRIPT_URL);
    
    const [responseMare, responseJacare] = await Promise.all([
      fetch(SCRIPT_URL + '?action=get&local=Maré'),
      fetch(SCRIPT_URL + '?action=get&local=Jacarezinho')
    ]);
    
    console.log('Response Mare status:', responseMare.status);
    console.log('Response Jacare status:', responseJacare.status);
    
    const resultMare = await responseMare.json();
    const resultJacare = await responseJacare.json();
    
    console.log('Resultado Maré:', resultMare);
    console.log('Resultado Jacarezinho:', resultJacare);
    
    if (resultMare.success) {
      dados.metasMare = resultMare.data || [];
      console.log('Metas Maré carregadas:', dados.metasMare.length);
    } else {
      console.error('Erro ao carregar Maré:', resultMare.message);
    }
    
    if (resultJacare.success) {
      dados.metasJacarezinho = resultJacare.data || [];
      console.log('Metas Jacarezinho carregadas:', dados.metasJacarezinho.length);
    } else {
      console.error('Erro ao carregar Jacarezinho:', resultJacare.message);
    }
    
    dados.carregando = false;
    renderizar();
  } catch (error) {
    console.error('Erro ao carregar:', error);
    dados.carregando = false;
    alert('Erro ao carregar dados: ' + error.message + '\n\nVerifique o console (F12) para mais detalhes.');
    renderizar();
  }
}

async function salvarMeta(meta, local) {
  try {
    // Criar um formulário invisível para fazer a requisição
    const form = document.createElement('form');
    form.method = 'GET';
    form.action = 'https://script.google.com/macros/s/AKfycbzYi7mEll9Y8RcDCfK7GM87vVZy9JXDnvxqk-RtfkQoXZzE_ebj8MXV7_vNx-3kuZ_4/exec';
    form.style.display = 'none';
    
    // Adicionar parâmetros como campos ocultos
    const params = {
      action: 'add',
      local: local,
      e: meta.e || '',
      m: meta.m || '',
      c: meta.c || '',
      st: meta.st || 'Em andamento',
      a: meta.a || '',
      d: meta.d || '',
      o: meta.o || '',
      l: meta.l || '',
      listaPresenca: meta.listaPresenca || '',
      fotos: meta.fotos || '',
      materialDivulgacao: meta.materialDivulgacao || ''
    };
    
    for (const key in params) {
      const input = document.createElement('input');
      input.name = key;
      input.value = params[key];
      form.appendChild(input);
    }
    
    document.body.appendChild(form);
    
    console.log('Enviando formulário para:', form.action);
    console.log('Dados:', params);
    
    // Usar fetch com modo no-cors
    const queryString = new URLSearchParams(params).toString();
    const url = form.action + '?' + queryString;
    
    const response = await fetch(url, {
      method: 'GET',
      mode: 'no-cors'
    });
    
    console.log('Meta salva com sucesso!');
    
    // Aguardar 2 segundos e recarregar
    await new Promise(r => setTimeout(r, 2000));
    await carregarTodasMetas();
    
    document.body.removeChild(form);
    return true;
    
  } catch (error) {
    console.error('Erro ao salvar:', error);
    alert('Meta salva! Recarregando dados...');
    await carregarTodasMetas();
    return true; // Considera como sucesso mesmo com erro CORS
  }
}
async function apagarMeta(id, local) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'delete',
        local: local,
        id: id
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      await carregarTodasMetas();
      return true;
    } else {
      throw new Error(result.message || 'Erro ao apagar');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao apagar meta: ' + error.message);
    return false;
  }
}

// ============================================
// FUNÇÕES DE ESTATÍSTICAS
// ============================================

function calcularEstatisticas(metas) {
  return {
    total: metas.length,
    emAndamento: metas.filter(m => m.st === 'Em andamento').length,
    encerradas: metas.filter(m => m.st === 'Encerrada').length,
    mediaProgresso: metas.length > 0 
      ? Math.round(metas.reduce((acc, m) => acc + (parseInt(m.a) || 0), 0) / metas.length)
      : 0
  };
}

function agruparPorEtapa(metas) {
  const grupos = {};
  metas.forEach(meta => {
    const etapa = meta.e || 'Sem Etapa';
    if (!grupos[etapa]) grupos[etapa] = [];
    grupos[etapa].push(meta);
  });
  return grupos;
}

function filtrarMetas(metas) {
  return metas.filter(meta => {
    if (dados.filtros.etapa && meta.e !== dados.filtros.etapa) return false;
    if (dados.filtros.status && meta.st !== dados.filtros.status) return false;
    if (dados.filtros.dataInicio && meta.d < dados.filtros.dataInicio) return false;
    if (dados.filtros.dataFim && meta.d > dados.filtros.dataFim) return false;
    return true;
  });
}

function obterEtapasUnicas() {
  const todasMetas = [...dados.metasMare, ...dados.metasJacarezinho];
  const etapas = [...new Set(todasMetas.map(m => m.e).filter(e => e))];
  return etapas.sort();
}

// ============================================
// FUNÇÕES DE EXPORTAÇÃO
// ============================================

function exportarParaExcel() {
  const metas = dados.visualizacao === 'mare' ? dados.metasMare :
                dados.visualizacao === 'jacarezinho' ? dados.metasJacarezinho :
                [...dados.metasMare, ...dados.metasJacarezinho];
  
  let csv = 'Território,Etapa,Meta,Comprovação,Status,Alcançada (%),Data,Observações,Link Evidência,Lista Presença,Fotos,Material Divulgação\n';
  
  metas.forEach(meta => {
    const territorio = dados.metasMare.includes(meta) ? 'Maré' : 'Jacarezinho';
    csv += `"${territorio}","${meta.e}","${meta.m}","${meta.c}","${meta.st}","${meta.a}","${meta.d}","${meta.o}","${meta.l}","${meta.listaPresenca || ''}","${meta.fotos || ''}","${meta.materialDivulgacao || ''}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `prospera-rio-metas-${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}

function imprimirRelatorio() {
  window.print();
}

// ============================================
// FUNÇÕES DE INTERFACE
// ============================================

function renderizar() {
  const app = document.getElementById('app');
  
  if (!dados.ok) {
    app.innerHTML = telaLogin();
  } else {
    app.innerHTML = telaPrincipal();
  }
}

function telaLogin() {
  return `
    <div class="login">
      <div class="login-box">
        <div class="logo-container">
          <img class="logo" 
               src="https://lh3.googleusercontent.com/d/1x5sNkC9vd7CI78y0xdkWvgoadxPEMcIf=w800" 
               alt="Prospera Rio">
          <div class="location-text">MARÉ · JACAREZINHO</div>
        </div>
        <h3 style="color: var(--azul-principal); margin: 24px 0;">Gestão de Metas e Evidências</h3>
        <input id="senha" type="password" placeholder="Digite a senha" style="margin: 24px 0;">
        <button class="btn-primary" onclick="fazerLogin()" style="width: 100%;">ENTRAR</button>
      </div>
    </div>
  `;
}

function telaPrincipal() {
  let conteudo = '';
  
  if (dados.visualizacao === 'dashboard') {
    conteudo = telaDashboard();
  } else if (dados.visualizacao === 'mare') {
    conteudo = telaTerritorioCompleta('Maré', dados.metasMare);
  } else if (dados.visualizacao === 'jacarezinho') {
    conteudo = telaTerritorioCompleta('Jacarezinho', dados.metasJacarezinho);
  } else if (dados.visualizacao === 'cadastro') {
    conteudo = telaCadastro();
  }
  
  return `
    <div class="hdr">
      <div class="hdr-top">
        <h2>PROSPERA RIO - GESTÃO DE METAS</h2>
        <div class="hdr-btns">
          <button onclick="exportarParaExcel()" class="btn-success">EXPORTAR EXCEL</button>
          <button onclick="imprimirRelatorio()">IMPRIMIR</button>
          <button onclick="sair()">SAIR</button>
        </div>
      </div>
      <div class="tabs">
        <button class="tab ${dados.visualizacao === 'dashboard' ? 'active' : ''}" 
                onclick="mudarVisualizacao('dashboard')">Dashboard</button>
        <button class="tab ${dados.visualizacao === 'mare' ? 'active' : ''}" 
                onclick="mudarVisualizacao('mare')">Maré</button>
        <button class="tab ${dados.visualizacao === 'jacarezinho' ? 'active' : ''}" 
                onclick="mudarVisualizacao('jacarezinho')">Jacarezinho</button>
        <button class="tab ${dados.visualizacao === 'cadastro' ? 'active' : ''}" 
                onclick="mudarVisualizacao('cadastro')">Nova Meta</button>
      </div>
    </div>
    <div class="main">
      ${conteudo}
    </div>
  `;
}

function telaDashboard() {
  const statsMare = calcularEstatisticas(dados.metasMare);
  const statsJacare = calcularEstatisticas(dados.metasJacarezinho);
  const statsTotal = {
    total: statsMare.total + statsJacare.total,
    emAndamento: statsMare.emAndamento + statsJacare.emAndamento,
    encerradas: statsMare.encerradas + statsJacare.encerradas,
    mediaProgresso: Math.round((statsMare.mediaProgresso + statsJacare.mediaProgresso) / 2)
  };
  
  return `
    <h3 style="color: var(--azul-principal); margin-bottom: 30px;">Visão Geral do Programa</h3>
    
    <div class="dashboard">
      <div class="stat-card">
        <h4>TOTAL DE METAS</h4>
        <div class="stat-number">${statsTotal.total}</div>
        <div class="stat-label">Ambos territórios</div>
      </div>
      
      <div class="stat-card">
        <h4>EM ANDAMENTO</h4>
        <div class="stat-number" style="color: #ffc107;">${statsTotal.emAndamento}</div>
        <div class="stat-label">Ativas no momento</div>
      </div>
      
      <div class="stat-card">
        <h4>ENCERRADAS</h4>
        <div class="stat-number" style="color: #28a745;">${statsTotal.encerradas}</div>
        <div class="stat-label">Concluídas</div>
      </div>
      
      <div class="stat-card">
        <h4>MÉDIA DE PROGRESSO</h4>
        <div class="stat-number" style="color: var(--azul-secundaria);">${statsTotal.mediaProgresso}%</div>
        <div class="stat-label">Progresso geral</div>
      </div>
    </div>
    
    <h3 style="color: var(--azul-principal); margin: 40px 0 30px;">Por Território</h3>
    
    <div class="dashboard">
      <div class="stat-card mare">
        <h4>MARÉ - TOTAL</h4>
        <div class="stat-number">${statsMare.total}</div>
        <div class="stat-label">Metas cadastradas</div>
      </div>
      
      <div class="stat-card mare">
        <h4>MARÉ - EM ANDAMENTO</h4>
        <div class="stat-number" style="color: #ffc107;">${statsMare.emAndamento}</div>
        <div class="stat-label">Ativas</div>
      </div>
      
      <div class="stat-card mare">
        <h4>MARÉ - ENCERRADAS</h4>
        <div class="stat-number" style="color: #28a745;">${statsMare.encerradas}</div>
        <div class="stat-label">Concluídas</div>
      </div>
      
      <div class="stat-card mare">
        <h4>MARÉ - PROGRESSO</h4>
        <div class="stat-number" style="color: #00B7D7;">${statsMare.mediaProgresso}%</div>
        <div class="stat-label">Média</div>
      </div>
    </div>
    
    <div class="dashboard" style="margin-top: 20px;">
      <div class="stat-card jacarezinho">
        <h4>JACAREZINHO - TOTAL</h4>
        <div class="stat-number">${statsJacare.total}</div>
        <div class="stat-label">Metas cadastradas</div>
      </div>
      
      <div class="stat-card jacarezinho">
        <h4>JACAREZINHO - EM ANDAMENTO</h4>
        <div class="stat-number" style="color: #ffc107;">${statsJacare.emAndamento}</div>
        <div class="stat-label">Ativas</div>
      </div>
      
      <div class="stat-card jacarezinho">
        <h4>JACAREZINHO - ENCERRADAS</h4>
        <div class="stat-number" style="color: #28a745;">${statsJacare.encerradas}</div>
        <div class="stat-label">Concluídas</div>
      </div>
      
      <div class="stat-card jacarezinho">
        <h4>JACAREZINHO - PROGRESSO</h4>
        <div class="stat-number" style="color: #ECC203;">${statsJacare.mediaProgresso}%</div>
        <div class="stat-label">Média</div>
      </div>
    </div>
  `;
}

function telaTerritorioCompleta(territorio, metas) {
  const metasFiltradas = filtrarMetas(metas);
  const gruposPorEtapa = agruparPorEtapa(metasFiltradas);
  const etapas = Object.keys(gruposPorEtapa).sort();
  const stats = calcularEstatisticas(metas);
  
  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
      <h3 style="color: var(--azul-principal);">
        ${territorio} - Todas as Metas e Evidências
      </h3>
      <span class="territorio-badge ${territorio.toLowerCase()}">${territorio.toUpperCase()}</span>
    </div>
    
    <div class="dashboard" style="margin-bottom: 30px;">
      <div class="stat-card">
        <h4>TOTAL</h4>
        <div class="stat-number">${stats.total}</div>
        <div class="stat-label">Metas</div>
      </div>
      <div class="stat-card">
        <h4>EM ANDAMENTO</h4>
        <div class="stat-number" style="color: #ffc107;">${stats.emAndamento}</div>
      </div>
      <div class="stat-card">
        <h4>ENCERRADAS</h4>
        <div class="stat-number" style="color: #28a745;">${stats.encerradas}</div>
      </div>
      <div class="stat-card">
        <h4>PROGRESSO MÉDIO</h4>
        <div class="stat-number" style="color: var(--azul-secundaria);">${stats.mediaProgresso}%</div>
      </div>
    </div>
    
    <div class="filters">
      <div class="filter-group">
        <label>Filtrar por Etapa:</label>
        <select id="filtroEtapa" onchange="aplicarFiltro('etapa', this.value)">
          <option value="">Todas as etapas</option>
          ${obterEtapasUnicas().map(e => `<option value="${e}" ${dados.filtros.etapa === e ? 'selected' : ''}>${e}</option>`).join('')}
        </select>
      </div>
      
      <div class="filter-group">
        <label>Filtrar por Status:</label>
        <select id="filtroStatus" onchange="aplicarFiltro('status', this.value)">
          <option value="">Todos</option>
          <option value="Em andamento" ${dados.filtros.status === 'Em andamento' ? 'selected' : ''}>Em andamento</option>
          <option value="Encerrada" ${dados.filtros.status === 'Encerrada' ? 'selected' : ''}>Encerrada</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Data Início:</label>
        <input type="date" id="filtroDataInicio" value="${dados.filtros.dataInicio}" 
               onchange="aplicarFiltro('dataInicio', this.value)">
      </div>
      
      <div class="filter-group">
        <label>Data Fim:</label>
        <input type="date" id="filtroDataFim" value="${dados.filtros.dataFim}" 
               onchange="aplicarFiltro('dataFim', this.value)">
      </div>
      
      <div class="filter-group" style="display: flex; align-items: flex-end;">
        <button onclick="limparFiltros()" class="btn-secondary">LIMPAR FILTROS</button>
      </div>
    </div>
  `;
  
  if (dados.carregando) {
    html += '<div class="loading">Carregando dados...</div>';
  } else if (metasFiltradas.length === 0) {
    html += '<div class="vazio">Nenhuma meta encontrada com os filtros aplicados.</div>';
  } else {
    etapas.forEach(etapa => {
      const metasEtapa = gruposPorEtapa[etapa];
      html += `
        <div class="etapa-section">
          <div class="etapa-header">
            <h3 class="etapa-title">${etapa}</h3>
            <span class="etapa-count">${metasEtapa.length} meta${metasEtapa.length !== 1 ? 's' : ''}</span>
          </div>
      `;
      
      metasEtapa.forEach(meta => {
        const statusClass = meta.st === 'Encerrada' ? 'status-encerrada' : 'status-andamento';
        const progresso = parseInt(meta.a) || 0;
        
        html += `
          <div class="meta-card">
            <div class="meta-header">
              <span class="meta-id">#${meta.id ? meta.id.substring(0, 8) : 'N/A'}</span>
              <span class="meta-status ${statusClass}">${meta.st || 'Em andamento'}</span>
            </div>
            
            <p class="meta-texto">${meta.m || 'Sem descrição'}</p>
            
            ${progresso > 0 ? `
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progresso}%">${progresso}%</div>
              </div>
            ` : ''}
            
            <div class="meta-info-grid">
              ${meta.c ? `
                <div class="meta-info-item">
                  <span class="meta-info-label">Comprovação</span>
                  <span class="meta-info-value">${meta.c}</span>
                </div>
              ` : ''}
              
              ${meta.d ? `
                <div class="meta-info-item">
                  <span class="meta-info-label">Data</span>
                  <span class="meta-info-value">${formatarData(meta.d)}</span>
                </div>
              ` : ''}
              
              ${meta.o ? `
                <div class="meta-info-item">
                  <span class="meta-info-label">Observações</span>
                  <span class="meta-info-value">${meta.o}</span>
                </div>
              ` : ''}
              
              ${meta.l ? `
                <div class="meta-info-item">
                  <span class="meta-info-label">Evidência</span>
                  <span class="meta-info-value">
                    <a href="${meta.l}" target="_blank" class="meta-link">Abrir link externo →</a>
                  </span>
                </div>
              ` : ''}
            </div>
            
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--cinza-neutro);">
              <button class="btn-danger" onclick="confirmarExclusao('${meta.id}', '${territorio}')">
                APAGAR META
              </button>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
    });
  }
  
  return html;
}

function telaCadastro() {
  return `
    <div class="box">
      <h3 class="form-title">Cadastrar Nova Meta</h3>
      
      <label class="field-required">Território</label>
      <select id="territorio">
        <option value="Maré">Maré</option>
        <option value="Jacarezinho">Jacarezinho</option>
      </select>
      
      <label class="field-required">Etapa</label>
      <input id="etapa" placeholder="Ex: Etapa 1, Fase Inicial, etc.">
      
      <label class="field-required">Descrição da Meta</label>
      <textarea id="meta" placeholder="Descreva detalhadamente a meta a ser alcançada e seus objetivos..."></textarea>
      
      <label>Forma de Comprovação</label>
      <input id="comprovacao" placeholder="Como esta meta será comprovada ou validada?">
      
      <label>Status da Meta</label>
      <select id="status">
        <option>Em andamento</option>
        <option>Encerrada</option>
      </select>
      
      <label>Percentual Alcançado (%)</label>
      <input id="alcancada" type="number" placeholder="0 a 100" min="0" max="100">
      
      <label>Data de Referência</label>
      <input id="data" type="date">
      
      <label>Observações Adicionais</label>
      <textarea id="observacao" placeholder="Informações complementares, contexto, detalhes relevantes..."></textarea>
      
      <h4 style="color: var(--azul-principal); margin-top: 30px; margin-bottom: 15px; border-top: 2px solid var(--cinza-neutro); padding-top: 20px;">
        EVIDÊNCIAS
      </h4>
      
      <label>Link de Evidência Principal</label>
      <input id="link" placeholder="https://" type="url">
      
      <label>Link da Lista de Presença</label>
      <input id="listaPresenca" placeholder="https://drive.google.com/..." type="url">
      
      <label>Link das Fotos</label>
      <input id="fotos" placeholder="https://drive.google.com/..." type="url">
      
      <label>Link do Material de Divulgação</label>
      <input id="materialDivulgacao" placeholder="https://drive.google.com/..." type="url">
      
      <div style="margin-top: 32px; padding-top: 24px; border-top: 2px solid var(--cinza-neutro);">
        <button class="btn-primary" onclick="salvarNovaMeta()" id="btnSalvar">SALVAR META</button>
        <button class="btn-secondary" onclick="mudarVisualizacao('dashboard')">CANCELAR</button>
      </div>
    </div>
  `;
}

// ============================================
// FUNÇÕES DE INTERAÇÃO
// ============================================

function fazerLogin() {
  const senha = document.getElementById('senha').value;
  if (senha === 'prospera2025') {
    dados.ok = true;
    carregarTodasMetas();
  } else {
    alert('Senha incorreta. Tente novamente.');
  }
}

function sair() {
  if (confirm('Deseja realmente sair do sistema?')) {
    dados.ok = false;
    dados.visualizacao = 'dashboard';
    renderizar();
  }
}

function mudarVisualizacao(tipo) {
  dados.visualizacao = tipo;
  renderizar();
}

function aplicarFiltro(tipo, valor) {
  dados.filtros[tipo] = valor;
  renderizar();
}

function limparFiltros() {
  dados.filtros = {
    etapa: '',
    status: '',
    dataInicio: '',
    dataFim: ''
  };
  renderizar();
}

async function salvarNovaMeta() {
  const btnSalvar = document.getElementById('btnSalvar');
  btnSalvar.disabled = true;
  btnSalvar.textContent = 'SALVANDO...';
  
  const meta = {
    e: document.getElementById('etapa').value.trim(),
    m: document.getElementById('meta').value.trim(),
    c: document.getElementById('comprovacao').value.trim(),
    st: document.getElementById('status').value,
    a: document.getElementById('alcancada').value,
    d: document.getElementById('data').value,
    o: document.getElementById('observacao').value.trim(),
    l: document.getElementById('link').value.trim(),
    listaPresenca: document.getElementById('listaPresenca').value.trim(),
    fotos: document.getElementById('fotos').value.trim(),
    materialDivulgacao: document.getElementById('materialDivulgacao').value.trim()
  };
  
  const territorio = document.getElementById('territorio').value;
  
  if (!meta.e || !meta.m) {
    alert('ATENÇÃO: Preencha os campos obrigatórios:\n\n• Etapa\n• Descrição da Meta');
    btnSalvar.disabled = false;
    btnSalvar.textContent = 'SALVAR META';
    return;
  }
  
  console.log('=== DEBUG: Salvando meta ===');
  console.log('Território:', territorio);
  console.log('Dados:', meta);
  
  const sucesso = await salvarMeta(meta, territorio);
  
  if (sucesso) {
    // Aguardar 3 segundos para o Google processar
    setTimeout(async () => {
      await carregarTodasMetas();
      alert('Meta cadastrada! Verifique na planilha do Google Sheets.');
      dados.visualizacao = territorio === 'Maré' ? 'mare' : 'jacarezinho';
      renderizar();
    }, 3000);
  } else {
    alert('Erro ao salvar. Verifique o console (F12).');
    btnSalvar.disabled = false;
    btnSalvar.textContent = 'SALVAR META';
  }
}

async function confirmarExclusao(id, territorio) {
  if (confirm('ATENÇÃO: Deseja realmente apagar esta meta?\n\nEsta ação não pode ser desfeita.')) {
    const sucesso = await apagarMeta(id, territorio);
    if (sucesso) {
      alert('Meta apagada com sucesso.');
    }
  }
}

function formatarData(data) {
  if (!data) return '';
  const partes = data.split('-');
  if (partes.length === 3) {
    return partes[2] + '/' + partes[1] + '/' + partes[0];
  }
  return data;
}

// ============================================
// INICIALIZAÇÃO
// ============================================
renderizar();
</script>
</body>
</html>
